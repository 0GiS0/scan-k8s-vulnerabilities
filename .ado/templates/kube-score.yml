parameters:
  - name: working_directory
    default: manifests

jobs:
  - job: kube_score
    # container: kube-score
    steps:
      - script: |
          (
            set -x; cd "$(mktemp -d)" &&
            OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
            ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
            KREW="krew-${OS}_${ARCH}" &&
            curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
            tar zxvf "${KREW}.tar.gz" &&
            ./"${KREW}" install krew
          )
          export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
          echo $PATH
        displayName: Install krew
      - script: |
          echo $PATH
          kubectl krew install score
        displayName: "Install kube-score"
      - script: kube-score score ${{ parameters.working_directory }}/*.yaml --output-format sarif > results.sarif
        displayName: Scan manifests using kube-score
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: "results.sarif"
          ArtifactName: "CodeAnalysisLogs"
          publishLocation: "Container"
